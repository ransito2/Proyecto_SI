<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Dashboard de Reportes Ciudadanos</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f4f6f9;
      margin: 0;
      padding: 0;
    }

    header {
      background: #34495e;
      color: white;
      padding: 24px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: 1px;
    }

    .container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
      padding: 24px;
    }

    .card {
      background: white;
      border-radius: 14px;
      padding: 24px;
      box-shadow: 0 4px 16px rgba(44, 62, 80, 0.08);
      transition: box-shadow 0.2s;
    }

    .card:hover {
      box-shadow: 0 8px 24px rgba(44, 62, 80, 0.16);
    }

    canvas {
      width: 100% !important;
      height: 320px !important;
    }

    footer {
      text-align: center;
      padding: 12px;
      background: #34495e;
      color: white;
      margin-top: 24px;
    }
  </style>
</head>

<body>
  <header>
    <h1>游늸 Dashboard de Reportes Ciudadanos</h1>
    <p>Reportes p칰blicos - Agosto 2025</p>
  </header>

  <div class="container">
    <div class="card" style="grid-column: span 2; height: 420px;"><h3 style="margin-top:0; text-align: center;">Distribuci&oacute;n por Categor&iacute;a</h3><canvas id="graficoCategorias"
  style="max-width:500px;max-height:350px;width:100%;height:350px;display:block;margin:0 auto;"></canvas></div>
    <div class="card"><h3 style="margin-top:0; text-align: center;">Reportes por Categor&iacute;a</h3><label for="filtroCategoria">Filtrar por categor칤a:</label> <select
  id="filtroCategoria"></select><canvas id="graficoEstados" style="margin-top:12px;max-width:500px;max-height:350px;width:100%;height:350px;display:block;margin:0 auto;"></canvas></div>
    <div class="card">
  <h3 style="margin-top:0; text-align: center;">Reportes por mes y estado</h3>
  <label for="filtroEstadoMes">Filtrar por estado:</label>
  <select id="filtroEstadoMes"></select>
  <label for="filtroAnio" style="margin-left:12px;">Filtrar por a침o:</label>
  <select id="filtroAnio"></select>
  <canvas id="graficoMeses" style="max-width:500px;max-height:350px;width:100%;height:350px;display:block;margin:0 auto;"></canvas>
    </div>
    <div class="card"><h3 style="margin-top:0; text-align: center;">Personas que m&aacute;s reportan</h3><canvas id="graficoReportantes"></canvas></div>
    <div class="card" style="height:420px;">
      <h3 style="margin-top:0; text-align: center;">Reportes Activos</h3>
      <div id="map" style="height:400px;width:100%;border-radius:12px;"></div>
    </div>
  </div>

  <footer>
    <p>ESPOL - Reportes Ciudadanos 2025</p>
  </footer>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const url = "dataset_reportaya_200_fechas_2025.csv";

    let registros = [];
    let radarChart;

    async function cargarDatos() {
      const response = await fetch(url);
      const data = await response.text();
      const filas = data.split("\n").map(f => f.split(","));
      const headers = filas[0];
      registros = filas.slice(1).map(f => {
        let obj = {};
        headers.forEach((h, i) => obj[h] = f[i]);
        return obj;
      });

      // --- 1. Distribuci칩n por Categor칤a (Doughnut grande) ---
      const catCount = {};
      registros.forEach(r => {
        let cat = r["Categoria"];
        if (cat) catCount[cat] = (catCount[cat] || 0) + 1;
      });
      new Chart(document.getElementById("graficoCategorias"), {
        type: "doughnut",
        data: {
          labels: Object.keys(catCount),
          datasets: [{
            data: Object.values(catCount),
            backgroundColor: ["#e67e22", "#3498db", "#9b59b6", "#2ecc71", "#f1c40f", "#c0392b", "#e74c3c", "#2980b9"]
          }]
        },
        options: {
          plugins: {
            legend: { position: 'right' },
            tooltip: { enabled: true }
          },
          animation: true,
          maintainAspectRatio: false,
          responsive: true
        }
      });

      // --- 2. Radar de Estado de los reportes con filtro por categor칤a ---
      const filtro = document.getElementById("filtroCategoria");
      filtro.innerHTML = '<option value="TODAS">Todas</option>' + Object.keys(catCount).map(cat => `<option value="${cat}">${cat}</option>`).join("");

      const estadosValidos = ["Pendiente", "Resuelto", "En revision"];

      function actualizarRadar(categoria) {
        let estados = {};
        registros.forEach(r => {
          if ((categoria === "TODAS" || r["Categoria"] === categoria) && estadosValidos.includes(r["Estado"])) {
            let est = r["Estado"];
            if (est) estados[est] = (estados[est] || 0) + 1;
          }
        });
        // Asegura que todos los estados aparezcan aunque tengan 0
        estadosValidos.forEach(e => { if (!(e in estados)) estados[e] = 0; });
        const ctx = document.getElementById("graficoEstados").getContext("2d");
        if (radarChart) radarChart.destroy();
        radarChart = new Chart(ctx, {
          type: "radar",
          data: {
            labels: estadosValidos,
            datasets: [{
              label: `Cantidad de reportes (${categoria})`,
              data: estadosValidos.map(e => estados[e]),
              backgroundColor: "rgba(52,152,219,0.2)",
              borderColor: "#2980b9"
            }]
          },
          options: { plugins: { title: { display: true, text: "Estado de los reportes" } } }
        });
      }
      filtro.onchange = e => actualizarRadar(e.target.value);
      actualizarRadar("TODAS");

      // --- 3. Reportes por mes y estado (Gr치fico de puntos con filtro por estado y a침o) ---
      const meses = ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"];
      const nombresMeses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
      // Filtros
      const filtroEstadoMes = document.getElementById("filtroEstadoMes");
      const filtroAnio = document.getElementById("filtroAnio");
      filtroEstadoMes.innerHTML = '<option value="TODOS">Todos</option>' + estadosValidos.map(e => `<option value="${e}">${e}</option>`).join("");
      // Obtener a침os 칰nicos
      const aniosUnicos = Array.from(new Set(registros.map(r => {
        let fecha = r["Fecha_Reporte"];
        if (!fecha) return null;
        let partes = fecha.split("/");
        return partes[2];
      }).filter(a => a)));
      filtroAnio.innerHTML = '<option value="TODOS">Todos</option>' + aniosUnicos.map(a => `<option value="${a}">${a}</option>`).join("");

      let chartMeses;
      function actualizarMeses() {
        const estadoSel = filtroEstadoMes.value;
        const anioSel = filtroAnio.value;
        // Contar reportes por mes
        let conteoMes = {};
        registros.forEach(r => {
          let fecha = r["Fecha_Reporte"];
          let estado = r["Estado"];
          if (!fecha) return;
          let partes = fecha.split("/");
          let mes = partes[1];
          let anio = partes[2];
          if (meses.includes(mes) && (estadoSel === "TODOS" || estado === estadoSel) && (anioSel === "TODOS" || anio === anioSel)) {
            conteoMes[mes] = (conteoMes[mes] || 0) + 1;
          }
        });
        // Ordenar meses
        let labels = meses;
        let data = labels.map(m => conteoMes[m] || 0);
        // Destruir gr치fico anterior
        if (chartMeses) chartMeses.destroy();
        chartMeses = new Chart(document.getElementById("graficoMeses"), {
          type: "scatter",
          data: {
            labels: labels.map((m, i) => nombresMeses[i]),
            datasets: [{
              label: "Reportes por mes",
              data: labels.map((m, i) => ({ x: i + 1, y: conteoMes[m] || 0 })),
              backgroundColor: "#e67e22"
            }]
          },
          options: {
            plugins: { title: { display: true,  }, legend: { display: false }, tooltip: { enabled: false } },
            animation: false,
            scales: {
              x: {
                type: 'linear',
                min: 1,
                max: 12,
                ticks: {
                  callback: function (value, index) { return nombresMeses[index] || value; },
                  stepSize: 1
                },
                title: { display: true, text: 'Mes' }
              },
              y: {
                title: { display: true, text: 'Cantidad' },
                beginAtZero: true
              }
            }
          }
        });
      }
      filtroEstadoMes.onchange = actualizarMeses;
      filtroAnio.onchange = actualizarMeses;
      actualizarMeses();

      // --- 4. Personas que m치s reportan (Top 6) ---
      const reportanteCount = {};
      registros.forEach(r => {
        let rep = r["Reportado_por"];
        if (rep) reportanteCount[rep] = (reportanteCount[rep] || 0) + 1;
      });
      const topReportantes = Object.entries(reportanteCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 6);
      new Chart(document.getElementById("graficoReportantes"), {
        type: "bar",
        data: {
          labels: topReportantes.map(r => r[0]),
          datasets: [{
            label: "Reportes",
            data: topReportantes.map(r => r[1]),
            backgroundColor: "#16a085"
          }]
        },
        options: {
          indexAxis: "y",
          plugins: { title: { display: true,  }, tooltip: { enabled: false } },
          animation: false
        }
      });

      // --- 5. Mapa interactivo con Leaflet ---
      const puntos = registros.map(r => ({
        lat: parseFloat(r["Latitud"]),
        lng: parseFloat(r["Longitud"]),
        categoria: r["Categoria"],
        estado: r["Estado"],
        descripcion: r["Descripcion"],
        barrio: r["Barrio"],
        reportado_por: r["Reportado_por"]
      })).filter(p => !isNaN(p.lat) && !isNaN(p.lng));

      const map = L.map('map').setView([puntos[0]?.lat || -2.1, puntos[0]?.lng || -79.9], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '춸 OpenStreetMap'
      }).addTo(map);
      puntos.forEach(p => {
        L.marker([p.lat, p.lng]).addTo(map)
          .bindPopup(`<b>${p.categoria}</b><br>${p.descripcion}<br><b>Estado:</b> ${p.estado}<br><b>Barrio:</b> ${p.barrio}<br><b>Reportado por:</b> ${p.reportado_por}`);
      });
    }

    cargarDatos();
  </script>
</body>

</html>
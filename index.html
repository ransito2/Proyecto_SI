<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard de Reportes Ciudadanos</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f4f6f9;
      margin: 0;
      padding: 0;
    }
    header {
      background: #34495e;
      color: white;
      padding: 24px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: 1px;
    }
    .container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
      padding: 24px;
    }
    .card {
      background: white;
      border-radius: 14px;
      padding: 24px;
      box-shadow: 0 4px 16px rgba(44,62,80,0.08);
      transition: box-shadow 0.2s;
    }
    .card:hover {
      box-shadow: 0 8px 24px rgba(44,62,80,0.16);
    }
    canvas {
      width: 100% !important;
      height: 320px !important;
    }
    footer {
      text-align: center;
      padding: 12px;
      background: #34495e;
      color: white;
      margin-top: 24px;
    }
  </style>
</head>
<body>
  <header>
    <h1>游늸 Dashboard de Reportes Ciudadanos</h1>
    <p>Reportes p칰blicos - Agosto 2025</p>
  </header>

  <div class="container">
    <div class="card"><canvas id="graficoCategorias"></canvas></div>
    <div class="card"><canvas id="graficoEstados"></canvas></div>
    <div class="card"><canvas id="graficoBarrios"></canvas></div>
    <div class="card"><canvas id="graficoReportantes"></canvas></div>
    <div class="card"><canvas id="graficoLineasTiempo"></canvas></div>
    <div class="card"><canvas id="graficoMapa"></canvas></div>
  </div>

  <footer>
    <p>ESPOL - Reportes Ciudadanos 2025</p>
  </footer>

  <script>
    const url = "dataset_reportaya_200_fechas_2025.csv";

    async function cargarDatos() {
      const response = await fetch(url);
      const data = await response.text();
      const filas = data.split("\n").map(f => f.split(","));
      const headers = filas[0];
      const registros = filas.slice(1).map(f => {
        let obj = {};
        headers.forEach((h, i) => obj[h] = f[i]);
        return obj;
      });

      // --- 1. Gr치fico de Categor칤as de Reporte (Doughnut) ---
      const catCount = {};
      registros.forEach(r => {
        let cat = r["Categoria"];
        if (cat) catCount[cat] = (catCount[cat] || 0) + 1;
      });
      new Chart(document.getElementById("graficoCategorias"), {
        type: "doughnut",
        data: {
          labels: Object.keys(catCount),
          datasets: [{
            data: Object.values(catCount),
            backgroundColor: ["#e67e22", "#3498db", "#9b59b6", "#2ecc71", "#f1c40f", "#c0392b"]
          }]
        },
        options: { plugins: { title: { display: true, text: "Distribuci칩n por Categor칤a" } } }
      });

      // --- 2. Gr치fico de Estados de Reporte (Pie) ---
      const estadoCount = {};
      registros.forEach(r => {
        let est = r["Estado"];
        if (est) estadoCount[est] = (estadoCount[est] || 0) + 1;
      });
      new Chart(document.getElementById("graficoEstados"), {
        type: "pie",
        data: {
          labels: Object.keys(estadoCount),
          datasets: [{
            data: Object.values(estadoCount),
            backgroundColor: ["#27ae60", "#e74c3c", "#f39c12", "#2980b9"]
          }]
        },
        options: { plugins: { title: { display: true, text: "Estado de los Reportes" } } }
      });

      // --- 3. Gr치fico de Barrios con m치s reportes (Bar) ---
      const barrioCount = {};
      registros.forEach(r => {
        let barrio = r["Barrio"];
        if (barrio) barrioCount[barrio] = (barrioCount[barrio] || 0) + 1;
      });
      // Top 6 barrios
      const topBarrios = Object.entries(barrioCount)
        .sort((a,b) => b[1]-a[1])
        .slice(0,6);
      new Chart(document.getElementById("graficoBarrios"), {
        type: "bar",
        data: {
          labels: topBarrios.map(b => b[0]),
          datasets: [{
            label: "Reportes",
            data: topBarrios.map(b => b[1]),
            backgroundColor: "#8e44ad"
          }]
        },
        options: { plugins: { title: { display: true, text: "Barrios con m치s reportes" } } }
      });

      // --- 4. Gr치fico de personas que m치s reportan (Horizontal Bar) ---
      const reportanteCount = {};
      registros.forEach(r => {
        let rep = r["Reportado_por"];
        if (rep) reportanteCount[rep] = (reportanteCount[rep] || 0) + 1;
      });
      // Top 6 reportantes
      const topReportantes = Object.entries(reportanteCount)
        .sort((a,b) => b[1]-a[1])
        .slice(0,6);
      new Chart(document.getElementById("graficoReportantes"), {
        type: "bar",
        data: {
          labels: topReportantes.map(r => r[0]),
          datasets: [{
            label: "Reportes",
            data: topReportantes.map(r => r[1]),
            backgroundColor: "#16a085"
          }]
        },
        options: { 
          indexAxis: "y",
          plugins: { title: { display: true, text: "Personas que m치s reportan" } }
        }
      });

      // --- 5. Gr치fico de reportes por mes (Line) ---
      const meses = {};
      registros.forEach(r => {
        let fecha = r["Fecha_Reporte"];
        if (fecha) {
          let [d,m,y] = fecha.split("/");
          let mes = `${m}/${y}`;
          meses[mes] = (meses[mes] || 0) + 1;
        }
      });
      const mesesOrdenados = Object.keys(meses).sort((a,b) => {
        let [ma,ya] = a.split("/"); let [mb,yb] = b.split("/");
        return ya !== yb ? ya - yb : ma - mb;
      });
      new Chart(document.getElementById("graficoLineasTiempo"), {
        type: "line",
        data: {
          labels: mesesOrdenados,
          datasets: [{
            label: "Reportes por mes",
            data: mesesOrdenados.map(m => meses[m]),
            fill: true,
            borderColor: "#e67e22",
            backgroundColor: "rgba(230,126,34,0.2)",
            tension: 0.3,
            pointBackgroundColor: "#e67e22"
          }]
        },
        options: { plugins: { title: { display: true, text: "Reportes por mes" } } }
      });

      // --- 6. Gr치fico de dispersi칩n geogr치fica (Scatter) ---
      const puntos = registros.map(r => ({
        x: parseFloat(r["Longitud"]),
        y: parseFloat(r["Latitud"]),
        label: r["Categoria"]
      })).filter(p => !isNaN(p.x) && !isNaN(p.y));
      new Chart(document.getElementById("graficoMapa"), {
        type: "scatter",
        data: {
          datasets: [{
            label: "Ubicaci칩n de reportes",
            data: puntos,
            backgroundColor: "#2980b9"
          }]
        },
        options: {
          plugins: { title: { display: true, text: "Mapa de reportes (Latitud/Longitud)" } },
          scales: {
            x: { title: { display: true, text: "Longitud" } },
            y: { title: { display: true, text: "Latitud" } }
          }
        }
      });
    }

    cargarDatos();
  </script>
</body>
</html>